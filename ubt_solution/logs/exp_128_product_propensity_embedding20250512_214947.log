INFO:__main__:Using custom task weights: {'churn': 0.0, 'category_propensity': 0.0, 'product_propensity': 1.0}
INFO:ubt_solution.config:Using CUDA version: 11.8
INFO:ubt_solution.data_processor:内存使用情况 [初始化数据集开始] - RSS: 547.67 MB, VMS: 23751.71 MB
INFO:ubt_solution.data_processor:正在加载相关用户ID，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/input/relevant_clients.npy
INFO:ubt_solution.data_processor:测试模式：只处理前 10000 个用户
INFO:ubt_solution.data_processor:系统可用内存: 321.59 GB
INFO:ubt_solution.data_processor:根据系统内存自动设置块大小为: 20000
INFO:ubt_solution.data_processor:将用户分成 1 个块进行处理，每块大约 20000 个用户
INFO:ubt_solution.data_processor:内存使用情况 [开始分块加载事件数据] - RSS: 555.39 MB, VMS: 23759.35 MB
INFO:ubt_solution.data_processor:处理用户块 1/1
INFO:ubt_solution.data_processor:开始并行加载当前块的事件数据...
INFO:ubt_solution.data_processor:正在加载 product_buy 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/product_buy.parquet
INFO:ubt_solution.data_processor:正在加载 add_to_cart 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/add_to_cart.parquet
INFO:ubt_solution.data_processor:正在加载 remove_from_cart 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/remove_from_cart.parquet
INFO:ubt_solution.data_processor:正在加载 page_visit 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/page_visit.parquet
INFO:ubt_solution.data_processor:正在加载 search_query 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/search_query.parquet
INFO:ubt_solution.data_processor:remove_from_cart 数据加载完成，形状: (39490, 4)
INFO:ubt_solution.data_processor:product_buy 数据加载完成，形状: (44985, 4)
INFO:ubt_solution.data_processor:add_to_cart 数据加载完成，形状: (87008, 4)
INFO:ubt_solution.data_processor:search_query 数据加载完成，形状: (156434, 5)
INFO:ubt_solution.data_processor:page_visit 数据加载完成，形状: (1213783, 4)
INFO:ubt_solution.data_processor:内存使用情况 [块 1 事件数据加载完成] - RSS: 1348.67 MB, VMS: 26543.23 MB
INFO:ubt_solution.data_processor:开始加载商品属性数据...
INFO:ubt_solution.data_processor:正在加载商品属性数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/product_properties.parquet
INFO:ubt_solution.data_processor:商品属性数据加载完成，形状: (1197634, 4)
INFO:ubt_solution.data_processor:商品属性数据加载完成
INFO:ubt_solution.data_processor:开始构建用户块 1 的序列...
INFO:ubt_solution.data_processor:开始构建用户序列...
INFO:ubt_solution.data_processor:内存使用情况 [开始构建用户序列] - RSS: 1563.33 MB, VMS: 26721.09 MB
INFO:ubt_solution.data_processor:找到缓存文件 /data/mhwang/Rec/RecSys/recsys2025/ubt_solution/ubt_solution/cache/user_sequences_479641934112442117.pkl，尝试加载...
INFO:ubt_solution.data_processor:成功从缓存加载 10000 个用户序列
INFO:ubt_solution.data_processor:块 1 处理完成，耗时: 93.11 秒
INFO:ubt_solution.data_processor:内存使用情况 [块 1 处理完成] - RSS: 1777.74 MB, VMS: 26933.09 MB
INFO:ubt_solution.data_processor:用户序列构建完成，共 10000 个用户
INFO:ubt_solution.data_processor:创建商品属性查找字典...
INFO:ubt_solution.data_processor:商品属性字典创建完成，包含 1197634 个商品
INFO:ubt_solution.data_processor:设置样本缓存大小为 5000
INFO:ubt_solution.data_processor:内存使用情况 [数据集初始化完成] - RSS: 2151.25 MB, VMS: 27288.03 MB
INFO:ubt_solution.data_processor:内存使用情况 [初始化数据集开始] - RSS: 2151.25 MB, VMS: 27288.03 MB
INFO:ubt_solution.data_processor:正在加载相关用户ID，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/input/relevant_clients.npy
INFO:ubt_solution.data_processor:测试模式：只处理前 10000 个用户
INFO:ubt_solution.data_processor:系统可用内存: 320.13 GB
INFO:ubt_solution.data_processor:根据系统内存自动设置块大小为: 20000
INFO:ubt_solution.data_processor:将用户分成 1 个块进行处理，每块大约 20000 个用户
INFO:ubt_solution.data_processor:内存使用情况 [开始分块加载事件数据] - RSS: 2158.61 MB, VMS: 27295.66 MB
INFO:ubt_solution.data_processor:处理用户块 1/1
INFO:ubt_solution.data_processor:开始并行加载当前块的事件数据...
INFO:ubt_solution.data_processor:正在加载 product_buy 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/product_buy.parquet
INFO:ubt_solution.data_processor:正在加载 add_to_cart 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/add_to_cart.parquet
INFO:ubt_solution.data_processor:正在加载 remove_from_cart 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/remove_from_cart.parquet
INFO:ubt_solution.data_processor:正在加载 page_visit 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/page_visit.parquet
INFO:ubt_solution.data_processor:正在加载 search_query 数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/search_query.parquet
INFO:ubt_solution.data_processor:remove_from_cart 数据加载完成，形状: (39490, 4)
INFO:ubt_solution.data_processor:product_buy 数据加载完成，形状: (44985, 4)
INFO:ubt_solution.data_processor:add_to_cart 数据加载完成，形状: (87008, 4)
INFO:ubt_solution.data_processor:search_query 数据加载完成，形状: (156434, 5)
INFO:ubt_solution.data_processor:page_visit 数据加载完成，形状: (1213783, 4)
INFO:ubt_solution.data_processor:内存使用情况 [块 1 事件数据加载完成] - RSS: 2253.61 MB, VMS: 28184.71 MB
INFO:ubt_solution.data_processor:开始加载商品属性数据...
INFO:ubt_solution.data_processor:正在加载商品属性数据，文件路径: /data/mhwang/Rec/RecSys/recsys2025/data/product_properties.parquet
INFO:ubt_solution.data_processor:商品属性数据加载完成，形状: (1197634, 4)
INFO:ubt_solution.data_processor:商品属性数据加载完成
INFO:ubt_solution.data_processor:开始构建用户块 1 的序列...
INFO:ubt_solution.data_processor:开始构建用户序列...
INFO:ubt_solution.data_processor:内存使用情况 [开始构建用户序列] - RSS: 2493.48 MB, VMS: 28374.37 MB
INFO:ubt_solution.data_processor:找到缓存文件 /data/mhwang/Rec/RecSys/recsys2025/ubt_solution/ubt_solution/cache/user_sequences_479641934112442117.pkl，尝试加载...
INFO:ubt_solution.data_processor:成功从缓存加载 10000 个用户序列
INFO:ubt_solution.data_processor:块 1 处理完成，耗时: 92.12 秒
INFO:ubt_solution.data_processor:内存使用情况 [块 1 处理完成] - RSS: 2709.82 MB, VMS: 28582.37 MB
INFO:ubt_solution.data_processor:用户序列构建完成，共 10000 个用户
INFO:ubt_solution.data_processor:创建商品属性查找字典...
INFO:ubt_solution.data_processor:商品属性字典创建完成，包含 1197634 个商品
INFO:ubt_solution.data_processor:设置样本缓存大小为 5000
INFO:ubt_solution.data_processor:内存使用情况 [数据集初始化完成] - RSS: 3116.59 MB, VMS: 28962.66 MB
/data_sdc/mhwang/miniconda3/envs/RecSys/lib/python3.11/site-packages/torch/nn/modules/transformer.py:379: UserWarning: enable_nested_tensor is True, but self.use_nested_tensor is False because encoder_layer.norm_first was True
  warnings.warn(
/data_sdc/mhwang/miniconda3/envs/RecSys/lib/python3.11/site-packages/torch/optim/lr_scheduler.py:62: UserWarning: The verbose parameter is deprecated. Please use get_last_lr() to access the learning rate.
  warnings.warn(
INFO:__main__:开始训练模型...
INFO:ubt_solution.trainer:Epoch 1/1
Training:   0%|          | 0/5 [00:00<?, ?it/s]INFO:ubt_solution.trainer:Batch 0: 开始训练
INFO:ubt_solution.trainer:Batch 0: 品类倾向性标签比例 = 22.07%
INFO:ubt_solution.trainer:Batch 0: 产品倾向性标签比例 = 2.69%
INFO:ubt_solution.model:品类倾向性: 452/2048 样本有标签 (22.07%)
INFO:ubt_solution.model:产品倾向性: 55/2048 样本有标签 (2.69%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6929494142532349,0.6934292912483215,0.6930617094039917
INFO:ubt_solution.model:total_loss:0.6930617094039917
INFO:ubt_solution.trainer:loss: 0.6930617094039917
Training:  20%|██        | 1/5 [00:22<01:30, 22.60s/it]INFO:ubt_solution.trainer:Batch 1: 开始训练
INFO:ubt_solution.model:品类倾向性: 434/2048 样本有标签 (21.19%)
INFO:ubt_solution.model:产品倾向性: 43/2048 样本有标签 (2.10%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6929000020027161,0.6934236884117126,0.6919006109237671
INFO:ubt_solution.model:total_loss:0.6919006109237671
INFO:ubt_solution.trainer:loss: 0.6919006109237671
Training:  40%|████      | 2/5 [00:33<00:46, 15.59s/it]INFO:ubt_solution.trainer:Batch 2: 开始训练
INFO:ubt_solution.model:品类倾向性: 444/2048 样本有标签 (21.68%)
INFO:ubt_solution.model:产品倾向性: 49/2048 样本有标签 (2.39%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6929187774658203,0.6934190988540649,0.6907287240028381
INFO:ubt_solution.model:total_loss:0.6907287240028381
INFO:ubt_solution.trainer:loss: 0.6907287240028381
Training:  60%|██████    | 3/5 [00:44<00:26, 13.39s/it]INFO:ubt_solution.trainer:Batch 3: 开始训练
INFO:ubt_solution.model:品类倾向性: 450/2048 样本有标签 (21.97%)
INFO:ubt_solution.model:产品倾向性: 63/2048 样本有标签 (3.08%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6929153800010681,0.6934074759483337,0.6895212531089783
INFO:ubt_solution.model:total_loss:0.6895212531089783
INFO:ubt_solution.trainer:loss: 0.6895212531089783
Training:  80%|████████  | 4/5 [00:54<00:12, 12.28s/it]INFO:ubt_solution.trainer:Batch 4: 开始训练
INFO:ubt_solution.model:品类倾向性: 376/1808 样本有标签 (20.80%)
INFO:ubt_solution.model:产品倾向性: 54/1808 样本有标签 (2.99%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6929630041122437,0.6934066414833069,0.688284158706665
INFO:ubt_solution.model:total_loss:0.688284158706665
INFO:ubt_solution.trainer:loss: 0.688284158706665
Training: 100%|██████████| 5/5 [01:03<00:00, 11.02s/it]Training: 100%|██████████| 5/5 [01:03<00:00, 12.72s/it]
INFO:ubt_solution.trainer:total_loss: 6907.5725440979, total_samples: 10000
INFO:ubt_solution.trainer:Epoch average loss: 0.6908
INFO:ubt_solution.trainer:训练集 category_propensity 标签比例: 21.56%
INFO:ubt_solution.trainer:训练集 product_propensity 标签比例: 2.64%
INFO:ubt_solution.trainer:Epoch average churn_loss: 0.0000
INFO:ubt_solution.trainer:Epoch average category_propensity_loss: 0.0000
INFO:ubt_solution.trainer:Epoch average product_propensity_loss: 0.0000
Validation:   0%|          | 0/5 [00:00<?, ?it/s]INFO:ubt_solution.model:品类倾向性: 580/2048 样本有标签 (28.32%)
INFO:ubt_solution.model:产品倾向性: 72/2048 样本有标签 (3.52%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6929746866226196,0.6935166120529175,0.6848743557929993
INFO:ubt_solution.model:total_loss:0.6848743557929993
Validation:  20%|██        | 1/5 [00:23<01:32, 23.19s/it]INFO:ubt_solution.model:品类倾向性: 605/2048 样本有标签 (29.54%)
INFO:ubt_solution.model:产品倾向性: 80/2048 样本有标签 (3.91%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6929713487625122,0.6935169696807861,0.6848856806755066
INFO:ubt_solution.model:total_loss:0.6848856806755066
Validation:  40%|████      | 2/5 [00:25<00:33, 11.04s/it]INFO:ubt_solution.model:品类倾向性: 423/2048 样本有标签 (20.65%)
INFO:ubt_solution.model:产品倾向性: 55/2048 样本有标签 (2.69%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6930404305458069,0.6935261487960815,0.6850634813308716
INFO:ubt_solution.model:total_loss:0.6850634813308716
Validation:  60%|██████    | 3/5 [00:27<00:13,  6.88s/it]INFO:ubt_solution.model:品类倾向性: 284/2048 样本有标签 (13.87%)
INFO:ubt_solution.model:产品倾向性: 22/2048 样本有标签 (1.07%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6930290460586548,0.6935470700263977,0.6851927638053894
INFO:ubt_solution.model:total_loss:0.6851927638053894
Validation:  80%|████████  | 4/5 [00:29<00:04,  4.73s/it]INFO:ubt_solution.model:品类倾向性: 264/1808 样本有标签 (14.60%)
INFO:ubt_solution.model:产品倾向性: 35/1808 样本有标签 (1.94%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6930730938911438,0.6935465335845947,0.6851800680160522
INFO:ubt_solution.model:total_loss:0.6851800680160522
Validation: 100%|██████████| 5/5 [00:30<00:00,  3.48s/it]Validation: 100%|██████████| 5/5 [00:30<00:00,  6.10s/it]
INFO:ubt_solution.trainer:churn_loss improved: 0.0000
INFO:ubt_solution.trainer:category_propensity_loss improved: 0.0000
INFO:ubt_solution.trainer:product_propensity_loss improved: 0.0000
INFO:ubt_solution.trainer:New best churn_auc: 0.5640
INFO:ubt_solution.trainer:New best category_propensity_accuracy: 0.4689
INFO:ubt_solution.trainer:New best product_propensity_accuracy: 0.9768
INFO:ubt_solution.trainer:保存最佳模型，验证损失: 0.6850
INFO:ubt_solution.trainer:Validation metrics: {'val_loss': 0.6850358907699585, 'churn_loss': 0.0, 'category_propensity_loss': 0.0, 'product_propensity_loss': 0.0, 'churn_auc': 0.5640245676040649, 'category_propensity_accuracy': 0.46890538930892944, 'category_propensity_pos_accuracy': 0.46890538930892944, 'product_propensity_accuracy': 0.9768182039260864, 'product_propensity_pos_accuracy': 0.9768182039260864}
INFO:ubt_solution.trainer:category_propensity 标签比例: 当前=21.56%, 平均=21.56%
INFO:ubt_solution.trainer:product_propensity 标签比例: 当前=2.64%, 平均=2.64%
INFO:__main__:生成用户嵌入向量...
Generating embeddings:   0%|          | 0/5 [00:00<?, ?it/s]INFO:ubt_solution.model:品类倾向性: 444/2048 样本有标签 (21.68%)
INFO:ubt_solution.model:产品倾向性: 59/2048 样本有标签 (2.88%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6930012106895447,0.6935268044471741,0.6850370168685913
INFO:ubt_solution.model:total_loss:0.6850370168685913
Generating embeddings:  20%|██        | 1/5 [00:13<00:55, 14.00s/it]INFO:ubt_solution.model:品类倾向性: 465/2048 样本有标签 (22.71%)
INFO:ubt_solution.model:产品倾向性: 60/2048 样本有标签 (2.93%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6930161714553833,0.6935253739356995,0.6850303411483765
INFO:ubt_solution.model:total_loss:0.6850303411483765
Generating embeddings:  40%|████      | 2/5 [00:16<00:20,  6.95s/it]INFO:ubt_solution.model:品类倾向性: 450/2048 样本有标签 (21.97%)
INFO:ubt_solution.model:产品倾向性: 52/2048 样本有标签 (2.54%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6930486559867859,0.6935258507728577,0.6850422620773315
INFO:ubt_solution.model:total_loss:0.6850422620773315
Generating embeddings:  60%|██████    | 3/5 [00:18<00:09,  4.69s/it]INFO:ubt_solution.model:品类倾向性: 440/2048 样本有标签 (21.48%)
INFO:ubt_solution.model:产品倾向性: 52/2048 样本有标签 (2.54%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6930384635925293,0.6935259699821472,0.6850348711013794
INFO:ubt_solution.model:total_loss:0.6850348711013794
Generating embeddings:  80%|████████  | 4/5 [00:20<00:03,  3.63s/it]INFO:ubt_solution.model:品类倾向性: 357/1808 样本有标签 (19.75%)
INFO:ubt_solution.model:产品倾向性: 41/1808 样本有标签 (2.27%)
INFO:ubt_solution.model:0.0,0.0,1.0
INFO:ubt_solution.model:0.6930151581764221,0.6935275197029114,0.685046911239624
INFO:ubt_solution.model:total_loss:0.685046911239624
Generating embeddings: 100%|██████████| 5/5 [00:23<00:00,  3.40s/it]Generating embeddings: 100%|██████████| 5/5 [00:23<00:00,  4.63s/it]
INFO:__main__:Saving embeddings
INFO:__main__:完成！
